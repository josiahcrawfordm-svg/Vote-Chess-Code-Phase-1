import java.io.*;
import java.net.*;
import java.util.*;
import java.util.concurrent.*;

public class VoteChessServer {
    private int port = 5000;
    private ChessGame game = new ChessGame();
    private VoteManager voteManager = new VoteManager();
    private List<Player> players = new CopyOnWriteArrayList<>();
    private List<ClientHandler> clients = new CopyOnWriteArrayList<>();
    private GameHistory history = new GameHistory();
    private ExecutorService pool = Executors.newCachedThreadPool();

    public void start() throws IOException {
        ServerSocket server = new ServerSocket(port);
        System.out.println("VoteChessServer started on port " + port);

        // Accept clients asynchronously
        while(true){
            Socket clientSocket = server.accept();
            ClientHandler handler = new ClientHandler(clientSocket);
            clients.add(handler);
            pool.execute(handler);
        }
    }

    // Broadcast game state to all clients
    private void broadcastState() {
        for(ClientHandler ch: clients){
            ch.sendGameState(game, history);
        }
    }

    // Execute winning move after voting period
    private void executeWinningMove() {
        String bestMove = voteManager.getWinningMove();
        if(bestMove != null){
            game.makeMove(bestMove);
            history.addMove(bestMove, game);
            voteManager.resetVotes(players);
            broadcastState();
        }
    }

    // ---------------- ClientHandler ----------------
    class ClientHandler implements Runnable {
        private Socket socket;
        private ObjectOutputStream out;
        private ObjectInputStream in;
        private Player player;

        public ClientHandler(Socket s) { this.socket = s; }

        public void run() {
            try {
                out = new ObjectOutputStream(socket.getOutputStream());
                in = new ObjectInputStream(socket.getInputStream());

                // Receive Player info
                player = (Player) in.readObject();
                players.add(player);
                System.out.println(player.username + " joined team " + player.team);

                // Listen for moves
                while(true){
                    Object obj = in.readObject();
                    if(obj instanceof String){
                        String move = (String)obj;
                        if(move.equalsIgnoreCase("Leave")){
                            players.remove(player);
                            clients.remove(this);
                            socket.close();
                            System.out.println(player.username + " left.");
                            break;
                        } else {
                            voteManager.castVote(player, move);
                        }
                    }
                }

            } catch(Exception e){ e.printStackTrace(); }
        }

        public void sendGameState(ChessGame game, GameHistory history){
            try {
                out.reset();
                out.writeObject(game);
                out.writeObject(history);
                out.flush();
            } catch(Exception e){ e.printStackTrace(); }
        }
    }

    public static void main(String[] args) throws IOException {
        new VoteChessServer().start();
    }
}
